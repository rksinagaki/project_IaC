name: Continuous Deployment (CD) Pipeline

on:
  push:
    branches:
      - main

env:
  ECR_REPOSITORY: your-lambda-ecr-repo-name # ECRãƒªãƒã‚¸ãƒˆãƒªå
  LAMBDA_FUNCTION_NAME: your-scraper-lambda-name
  
  GLUE_SCRIPT_BUCKET: your-glue-script-bucket-name
  GLUE_SCRIPT_PATH: scripts/latest/app_glue.py # S3ä¸Šã®ãƒ‘ã‚¹

jobs:
  cd:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      id-token: write 
      contents: read
    
    steps:
      - name: ğŸ’» ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      # --- AWS OIDC èªè¨¼ ---
      - name: ğŸ”‘ AWSèªè¨¼æƒ…å ±ã®æ§‹æˆ (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # --- ECR ãƒ­ã‚°ã‚¤ãƒ³ ---
      - name: ğŸ³ ECRã¸ãƒ­ã‚°ã‚¤ãƒ³
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        
      # --- Lambda ãƒ‡ãƒ—ãƒ­ã‚¤ (ã‚³ãƒ³ãƒ†ãƒŠ) ---
      - name: ğŸ—ï¸ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã¨ã‚¿ã‚°ä»˜ã‘
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Dockerfileã®ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã—ã¦ãã ã•ã„
          docker build -t ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} ./src/lambda/ 
          docker tag ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest

      - name: â« ECRã¸ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest

      - name: ğŸ”„ Lambdaã®ã‚¤ãƒ¡ãƒ¼ã‚¸URIã‚’æ›´æ–°
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --image-uri ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest \
            --region ${{ secrets.AWS_REGION }}

      # --- Glue Job ãƒ‡ãƒ—ãƒ­ã‚¤ (S3) ---
      - name: â¬†ï¸ Glue Jobã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        run: |
          # Glueã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„
          aws s3 cp src/glue/app_glue.py s3://${{ env.GLUE_SCRIPT_BUCKET }}/${{ env.GLUE_SCRIPT_PATH }} \
            --region ${{ secrets.AWS_REGION }}