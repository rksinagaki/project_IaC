## README: Terraformによる、BigQueryデータ基盤の実装

### 1. 概要
YouTubeチャンネルのデータを収集・加工し、DWHに格納することで、分析を可能にするためのサーバーレスなデータ基盤とETLパイプラインの定義を管理します。

### 2. データパイプラインのアーキテクチャ

本パイプラインは、イベント駆動型のサーバーレスワークフローを採用しており、データの収集から分析基盤への格納までを自動化します。

#### パイプライン実行ステップとリソース

| \# | ステップ | サービス | 役割 |
| :--- | :--- | :--- | :--- |
| **0** | **スケジュール設定** | **EventBridge Scheduler** | データ収集の開始時刻や頻度を定義し、パイプラインの実行を定期的に（Youtubeチャンネルごとに）起動します。 |
| **1** | **初期処理/起動** | **Lambda** | EventBridge Schedulerによって起動され、チャンネルごとの処理に必要なパラメータ（`correlation_id`、S3パスなど）を準備し、次のStep Functionsへイベントを引き渡します。 |
| **2** | **ワークフロー引き継ぎ** | **EventBridge** | Lambdaからの情報をイベントとして受け取り、その情報に基づいて特定のStep Functions (SFN) を起動します。 |
| **3** | **オーケストレーション** | **AWS Step Functions (SFN)** | ETLワークフロー全体を管理します。Glueジョブの実行と完了を同期的に待機し、エラー発生時はクリーンアップと通知のフローを制御します。 |
| **4** | **データ加工 (ETL)** | **AWS Glue** | SFNからの指示に基づき、S3上の生データを読み込み、Spark環境でビジネスロジックに従ったデータ加工（クリーニング、集計）を実行します。 |
| **5** | **メタデータ更新** | **AWS Glue Crawler** | GlueジョブによってS3に書き込まれた加工済みデータ（Processed Data）をスキャンし、スキーマ（テーブル定義）を自動的に検出し、Glue Data Catalogに登録します。 |
| **6** | **分析基盤格納** | **Glue Job / BigQuery** | Glueジョブの処理結果（加工済みデータ）を、最終的な分析・BIツール連携のために**Google BigQuery**へ格納します。 |
| **7** | **通知/監視** | **Amazon SNS** | SFNの実行結果（成功/失敗）を最終的に通知し、オペレーション状況を関係者に共有します。 |

-----

### 3\. 環境構築

本プロジェクトは、すべてのインフラをTerraformで管理しますが、パイプラインの機能に必要な**機密情報**と**実行コード**は、セキュリティと柔軟性の観点から**手動で設定**する必要があります。

#### 3.1. 認証情報とコードの手動設定

Terraformの `apply` を実行する前後に、以下の項目を手動で設定・準備する必要があります。

| 項目 | 設定先 | 役割と内容 |
| :--- | :--- | :--- |
| **Google YouTube API Key** | **AWS Secrets Manager** | YouTubeからのデータ取得に必要な認証情報です。Secret Managerに安全に格納し、Lambda関数から参照できるようにします。 |
| **BigQuery サービスアカウントキー** | **AWS Secrets Manager** | GlueジョブがGoogle BigQueryへデータを書き込むための認証キー（JSON形式）です。Secret Managerに格納します。 |
| **Lambdaのコンテナイメージ** | **Amazon ECR** | Lambda関数として実行するコードのコンテナイメージを、事前に構築し、**Amazon ECR (Elastic Container Registry)** にプッシュしておく必要があります。 |
| **Glueのスクリプト** | **Amazon S3** | ETL処理を行うGlueジョブのPython/Sparkスクリプトを、事前にS3バケットの**所定のパス**にアップロードしておく必要があります。 |

#### 3.2. AWS認証情報の設定

AWS CLIを使用して、Terraformがリソースを作成・変更できる認証情報を設定します。

```bash
aws configure
```

#### 3.3. バックエンドの初期化

リポジトリのルートディレクトリで、Terraformのバックエンドを初期化します。

```bash
terraform init
```

-----

### 4\. 実行とデプロイ

手動設定が完了した後、インフラの変更をAWSに適用します。

1. **変更点の確認 (Plan):**
    ```bash
    terraform plan
    ```
2.  **変更の適用 (Apply):**
    ```bash
    terraform apply
    ```

2.  **リソースのクリーンアップ (Destroy):**
    ```bash
    terraform destroy
    ```
---
